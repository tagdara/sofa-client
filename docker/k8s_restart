if [[ -z "${KUBE_MANAGER}" ]]; then
  echo "KUBE_MANAGER export needed - No Microk8s Kubernetes manager specified to restart sofa service (user@kubehost)"
  exit 1
fi

if [[ -z "${KUBE_NAMESPACE}" ]]; then
  echo "No KUBE_NAMESPACE specified - using production"
  export KUBE_NAMESPACE=production
fi


name=$(grep -Po '"'"name"'"\s*:\s*"\K([^"]*)' ../package.json)
version=$(grep -Po '"'"version"'"\s*:\s*"\K([^"]*)' ../package.json)

# this can be changed for apps that have a prefix as part of a larger project to strip the prefix as needed
shortname=$name
echo $name $version [$shortname]

echo "Restarting $shortname service at $KUBE_MANAGER"

ssh -t $KUBE_MANAGER microk8s kubectl set image -n $KUBE_NAMESPACE statefulset.apps/$shortname $shortname=$DOCKER_REPOSITORY/$name:$version
ssh -t $KUBE_MANAGER microk8s kubectl rollout restart statefulset $shortname -n $KUBE_NAMESPACE
