(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{307:function(e,t,n){"use strict";n.r(t),n.d(t,"DataProvider",function(){return h}),n.d(t,"DataContext",function(){return m}),n.d(t,"withSofaTheme",function(){return y}),n.d(t,"realwithThemeChange",function(){return g}),n.d(t,"withThemeChange",function(){return S}),n.d(t,"withData",function(){return b});var o=n(0),r=n.n(o),i=n(220);function c(e){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(){return(a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),o.forEach(function(t){p(e,t,n[t])})}return e}function l(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e,t){return(d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=Object(i.a)({Component:o.Component,createElement:o.createElement}),h=function(e){function t(e){var n,o,r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),o=this,r=u(t).call(this,e),n=!r||"object"!==c(r)&&"function"!=typeof r?f(o):r,p(f(f(n)),"uuidv4",function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)})}),p(f(f(n)),"onOpen",function(e){n.setState({websocketStatus:"connected"}),console.log("Websocket connected.")}),p(f(f(n)),"onMessage",function(e){var t=JSON.parse(e.data);if(t.hasOwnProperty("event")){var o=n.state.deviceState;for(var r in n.state.deviceState)if(n.state.deviceState[r].event.endpoint.endpointId==t.event.endpoint.endpointId){if((t.event.header.name="ChangeReport")&&t.payload.hasOwnProperty("change")){for(var i=0;i<t.payload.change.properties.length;i++)t.context.properties.push(t.payload.change.properties[i]);t.payload={},t.event.header.name="StateReport"}o[r]=t}n.setState({deviceState:o})}else n.setState({rawUpdate:JSON.parse(e.data)})}),p(f(f(n)),"onReconnect",function(e){console.log("> Reconnecting...",e)}),p(f(f(n)),"sendMessage",function(e){console.log("Sending",e),n.state.socket.send(e)}),p(f(f(n)),"sendAlexaCommand",function(e,t,o,r,i){""==t&&(console.log("No endpoint ID was provided for ",e,o,r,i),t=n.deviceByName(e).endpointId);var c={name:r,namespace:"Alexa."+o,payloadVersion:"3",messageId:n.uuidv4(),correlationToken:n.uuidv4()},a={endpointId:t,cookie:{},scope:{type:"BearerToken",token:"access-token-from-skill"}};if(n.state.controllers[o][r])var s=JSON.parse(JSON.stringify(n.state.controllers[o][r]));else s={};for(var l in s)if("value"==s[l]){s[l]=i;break}var u={directive:{header:c,endpoint:a,payload:s}};console.log("Sending alexa command:",u),fetch("/directive",{method:"post",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(u)}).then(function(e){return console.log("Alexa command response:",e)})}),p(f(f(n)),"mergeState",function(e,t){if(void 0!==e&&void 0!==t){var o=s({},n.state.deviceState);return o[e]=t,n.setState({deviceState:o}),!0}}),p(f(f(n)),"mergeStates",function(e){var t=s({},n.state.deviceState,e);n.setState({deviceState:t},function(){return console.log("Merge state done",Object.keys(e).length)})}),p(f(f(n)),"updateDevice",function(e){n.pendingDevs.includes(e)||(n.pendingDevs.push(e),fetch("/data/devices/"+e+"?stateReport").then(function(e){return e.json()}).then(function(t){return n.mergeState(e,t)}))}),p(f(f(n)),"updateMultipleDevices",function(e){console.log("getting updates for multiple devices",e.length),fetch("/deviceState",{method:"post",headers:{Accept:"application/json, text/plain, */*","Content-Type":"application/json"},body:JSON.stringify(e)}).then(function(e){return e.json()}).then(function(e){return n.mergeStates(e)})}),p(f(f(n)),"updateDeviceList",function(e){console.log("updating devices",e);for(var t=[],o=0;o<e.length;o++)t.push(e[o].friendlyName);n.setState({devices:e},function(){return n.updateMultipleDevices(t)})}),p(f(f(n)),"devicesByCategory",function(e){e||(e="ALL");for(var t=[],o=0;o<n.state.devices.length;o++)(n.state.devices[o].displayCategories.includes(e)||"ALL"==e)&&t.push(n.state.devices[o]);return t.sort(function(e,t){var n=e.friendlyName.toLowerCase(),o=t.friendlyName.toLowerCase();return n<o?-1:n>o?1:0}),console.log("cat devs for",e,t),t}),p(f(f(n)),"deviceByName",function(e){for(var t=0;t<n.state.devices.length;t++)if(n.state.devices[t].friendlyName==e)return n.state.devices[t]}),p(f(f(n)),"deviceByEndpointId",function(e){for(var t=0;t<n.state.devices.length;t++)if(n.state.devices[t].endpointId==e)return n.state.devices[t];console.log("Did not find device named",e,n.state.devices.length)}),p(f(f(n)),"propertiesFromDevices",function(e){var t={},o=[];if(null==e)return t;Array.isArray(e)||(e=[e]);for(var r=0;r<e.length;r++)if(t[e[r].friendlyName]={},n.state.deviceState.hasOwnProperty(e[r].friendlyName)){if(n.state.deviceState[e[r].friendlyName].hasOwnProperty("context"))for(var i=0;i<n.state.deviceState[e[r].friendlyName].context.properties.length;i++)t[e[r].friendlyName][n.state.deviceState[e[r].friendlyName].context.properties[i].name]=n.state.deviceState[e[r].friendlyName].context.properties[i].value}else n.pendingDevs.includes(e[r].friendlyName)||(n.pendingDevs.push(e[r].friendlyName),o.push(e[r].friendlyName));return o.length>0&&n.updateMultipleDevices(o),t}),p(f(f(n)),"setColorScheme",function(e){console.log("set color scheme",e),console.log("this",f(f(n))),n.setState({colorScheme:e})}),n.state={devices:[],deviceState:{},controllers:{},virtualDevices:{},server:"wss://"+window.location.hostname+"/ws",socket:null,websocketStatus:"init",colorScheme:""},n.pendingDevs=[],n.deviceByName=n.deviceByName.bind(f(f(n))),n.devicesByCategory=n.devicesByCategory.bind(f(f(n))),n}var n,i,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}(t,o["Component"]),n=t,(i=[{key:"componentDidMount",value:function(){var e=this;window.addEventListener("resize",this.handleWindowSizeChange),console.log("Fetching device info"),fetch("/deviceList").then(function(e){return e.json()}).then(function(t){return e.updateDeviceList(t)}),fetch("/controllercommands").then(function(e){return e.json()}).then(function(t){return e.setState({controllers:t})}),fetch("/list/logic/virtualDevices").then(function(e){return e.json()}).then(function(t){return e.setState({virtualDevices:t})})}},{key:"render",value:function(){var e=this,t=this.props.children;return r.a.createElement(m.Provider,{value:{state:this.state,devices:this.state.devices,deviceState:this.state.deviceState,virtualDevices:this.state.virtualDevices,websocketStatus:this.state.websocketStatus,controllers:this.state.controllers,sendAlexaCommand:this.sendAlexaCommand,deviceByName:this.deviceByName,devicesByCategory:this.devicesByCategory,propertiesFromDevices:this.propertiesFromDevices,deviceByEndpointId:this.deviceByEndpointId,colorScheme:this.state.colorScheme,setColorScheme:this.setColorScheme}},t,r.a.createElement(v,{url:this.state.server,getSocket:function(t){e.setState({socket:t})},maxAttempts:25,onopen:this.onOpen,onmessage:this.onMessage,onreconnect:this.onReconnect}))}}])&&l(n.prototype,i),a&&l(n,a),t}(),m=r.a.createContext(h);function y(e){return function(t){return r.a.createElement(m.Consumer,null,function(n){var o=n.colorScheme;return r.a.createElement(e,a({},t,{colorScheme:o}))})}}function g(e){return function(t){return r.a.createElement(m.Consumer,null,function(n){var o=n.setColorScheme,i=n.colorScheme;return r.a.createElement(e,a({},t,{setColorScheme:o,colorScheme:i}))})}}function S(e){return function(t){return r.a.createElement(m.Consumer,null,function(n){return r.a.createElement(e,a({},t,{context:n,setColorScheme:n.setColorScheme,colorScheme:n.colorScheme}))})}}function b(e){return function(t){return r.a.createElement(m.Consumer,null,function(n){var o=n.controllers,i=n.virtualDevices,c=n.deviceByEndpointId,s=(n.devices,n.deviceState,n.websocketStatus),l=n.deviceByName,u=n.devicesByCategory,d=n.propertiesFromDevices,f=n.sendAlexaCommand;return r.a.createElement(e,a({},t,{cat:s,deviceByEndpointId:c,controllers:o,virtualDevices:i,deviceByName:l,deviceProperties:d(u(t.Category)),devicesByCategory:u,propertiesFromDevices:d,sendAlexaCommand:f,devices:u(t.Category)}))})}}}}]);